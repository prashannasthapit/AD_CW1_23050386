@using Application.Interfaces
@using Domain.Entities
@inject IJournalService JournalService

<div class="tag-selector">
    <MudText Typo="Typo.subtitle2" Class="mb-2">Tags</MudText>
    
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
        <MudAutocomplete T="Tag"
                         @bind-Value="_selectedTag"
                         Label="Add Tag"
                         SearchFunc="SearchTags"
                         ToStringFunc="@(t => t?.Name ?? "")"
                         Dense="true"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         ResetValueOnEmptyText="true"
                         CoerceText="false"
                         CoerceValue="false"
                         Style="flex: 1;" />
        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                       Color="Color.Primary" 
                       Size="Size.Small"
                       OnClick="AddSelectedTag" />
    </MudStack>
    
    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3">
        <MudTextField @bind-Value="_newTagName"
                      Label="Or create new tag"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Style="flex: 1;"
                      Immediate="true"
                      OnKeyDown="OnNewTagKeyDown" />
        <MudIconButton Icon="@Icons.Material.Filled.Add" 
                       Color="Color.Secondary" 
                       Size="Size.Small"
                       OnClick="CreateAndAddTag" />
    </MudStack>

    <MudText Typo="Typo.caption" Color="Color.Primary" Class="mb-1">Selected Tags</MudText>
    <MudChipSet T="Tag" Class="mb-3">
        @foreach (var tag in SelectedTags)
        {
            <MudChip T="Tag" 
                     Value="@tag"
                     Color="@(tag.IsPrebuilt ? Color.Primary : Color.Secondary)"
                     Variant="Variant.Filled"
                     Size="Size.Small"
                     OnClose="@(() => RemoveTag(tag))">
                @tag.Name
            </MudChip>
        }
    </MudChipSet>

    @if (ShowPrebuiltSuggestions && _prebuiltTags.Any())
    {
        <MudExpansionPanels Dense="true" Class="mt-2">
            <MudExpansionPanel Text="Quick Add (Pre-built Tags)" Dense="true" Expanded="false">
                <MudChipSet T="Tag">
                    @foreach (var tag in _prebuiltTags.Where(t => !SelectedTags.Any(s => s.Id == t.Id)))
                    {
                        <MudChip T="Tag"
                                 Value="@tag"
                                 Color="Color.Default"
                                 Variant="Variant.Outlined"
                                 Size="Size.Small"
                                 OnClick="@(() => AddTag(tag))">
                            @tag.Name
                        </MudChip>
                    }
                </MudChipSet>
            </MudExpansionPanel>
        </MudExpansionPanels>
    }
</div>

@code {
    [Parameter] public IList<Tag> SelectedTags { get; set; } = new List<Tag>();
    [Parameter] public EventCallback<IList<Tag>> SelectedTagsChanged { get; set; }
    [Parameter] public bool ShowPrebuiltSuggestions { get; set; } = true;

    private IList<Tag> _allTags = new List<Tag>();
    private IList<Tag> _prebuiltTags = new List<Tag>();
    private Tag? _selectedTag;
    private string _newTagName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadTags();
    }

    private async Task LoadTags()
    {
        _allTags = await JournalService.GetAllTagsAsync();
        _prebuiltTags = _allTags.Where(t => t.IsPrebuilt).ToList();
    }

    private Task<IEnumerable<Tag>> SearchTags(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(_allTags.Where(t => !SelectedTags.Any(s => s.Id == t.Id)).Take(10));

        return Task.FromResult(_allTags
            .Where(t => t.Name.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Where(t => !SelectedTags.Any(s => s.Id == t.Id))
            .Take(10));
    }

    private async Task AddSelectedTag()
    {
        if (_selectedTag != null)
        {
            await AddTag(_selectedTag);
            _selectedTag = null;
        }
    }

    private async Task AddTag(Tag tag)
    {
        if (!SelectedTags.Any(t => t.Id == tag.Id))
        {
            SelectedTags.Add(tag);
            await SelectedTagsChanged.InvokeAsync(SelectedTags);
        }
    }

    private async Task RemoveTag(Tag tag)
    {
        var toRemove = SelectedTags.FirstOrDefault(t => t.Id == tag.Id);
        if (toRemove != null)
        {
            SelectedTags.Remove(toRemove);
            await SelectedTagsChanged.InvokeAsync(SelectedTags);
        }
    }

    private async Task CreateAndAddTag()
    {
        if (string.IsNullOrWhiteSpace(_newTagName))
            return;

        var newTag = await JournalService.AddTagAsync(_newTagName.Trim());
        await AddTag(newTag);
        _newTagName = string.Empty;
        await LoadTags();
    }

    private async Task OnNewTagKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await CreateAndAddTag();
        }
    }
}
