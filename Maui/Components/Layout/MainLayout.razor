@inherits LayoutComponentBase
@inject IJSRuntime JS
@inject IUserService UserService
@inject IThemeService ThemeService
@implements IDisposable

<div class="page">
    <div class="sidebar">
        <NavMenu/>
    </div>

    <main>
        <div class="header-row px-4 d-flex justify-content-end align-items-center">
            <button class="btn btn-sm btn-outline-secondary me-3" @onclick="ToggleTheme">
                @if (ThemeService.CurrentTheme == "dark")
                {
                    <span>☀️ Light</span>
                }
                else
                {
                    <span>🌙 Dark</span>
                }
            </button>
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Subscribe to theme changes
            ThemeService.OnThemeChanged += OnThemeChanged;

            // Check if user is logged in and has a theme preference
            var userResult = await UserService.GetCurrentUserAsync();
            if (userResult.Success && userResult.Data != null)
            {
                ThemeService.SetTheme(userResult.Data.Theme.ToLower());
            }
            else
            {
                var currentTheme = await JS.InvokeAsync<string>("getTheme");
                ThemeService.SetTheme(currentTheme);
            }
            
            await JS.InvokeVoidAsync("setTheme", ThemeService.CurrentTheme);
            StateHasChanged();
        }
    }

    private async void OnThemeChanged()
    {
        await JS.InvokeVoidAsync("setTheme", ThemeService.CurrentTheme);
        await InvokeAsync(StateHasChanged);
    }

    private async Task ToggleTheme()
    {
        var newTheme = ThemeService.CurrentTheme == "light" ? "dark" : "light";
        ThemeService.SetTheme(newTheme);
        
        // Update user theme preference if logged in
        var userResult = await UserService.GetCurrentUserAsync();
        if (userResult.Success && userResult.Data != null)
        {
            var theme = newTheme == "dark" ? "Dark" : "Light";
            await UserService.UpdateThemeAsync(userResult.Data.Id, theme);
        }
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
