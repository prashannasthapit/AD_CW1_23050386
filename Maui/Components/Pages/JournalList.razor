@page "/entries"
@inject IJournalService JournalService
@inject IUserService UserService
@inject IJSRuntime JS
@inject IPdfService PdfService
@using Domain.Entities

<h3>Journal Entries</h3>

@if (_isLoading)
{
    <p>Loading entries...</p>
}
else if (!_isLoggedIn)
{
    <p>Please <a href="/login">login</a> to view your journal entries.</p>
}
else
{
    <div class="container mt-4">
        <!-- Search & Filter -->
        <div class="card mb-4">
            <div class="card-header">
                <strong>Search & Filter</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" @bind="_searchModel.Query"
                               placeholder="Search content..."/>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">From</label>
                        <input type="date" class="form-control" @bind="_fromDate"/>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">To</label>
                        <input type="date" class="form-control" @bind="_toDate"/>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Mood</label>
                        <select class="form-select" @bind="_selectedMood">
                            <option value="">All Moods</option>
                            @foreach (var mood in Enum.GetValues<Mood>())
                            {
                                <option value="@mood">@mood.GetEmoji() @mood</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2 mb-2 d-flex align-items-end">
                        <button class="btn btn-primary w-100" @onclick="Search">Search</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4 p-2 rounded">
            <!-- Left side: Total entries -->
            <span class="h6 mb-0 text-muted">
                Total: <strong>@_searchResult.TotalCount</strong> entries
            </span>

            <!-- Right side: Action buttons -->
            <div class="btn-group" role="group" aria-label="Actions">
                <a href="/journal" class="btn btn-success">
                    <i class="bi bi-plus-lg me-1"></i> New Entry
                </a>
                <button class="btn btn-outline-secondary" @onclick="ExportJournalsToPdf">
                    <i class="bi bi-file-earmark-pdf me-1"></i> Export Filtered Journals
                </button>
            </div>
        </div>


        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }

        @if (_searchResult.Entries.Any())
        {
            <div class="list-group">
                @foreach (var entry in _searchResult.Entries)
                {
                    <a href="/journal/view/@entry.EntryDate.ToString("yyyy-MM-dd")"
                       class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                @entry.PrimaryMood.GetEmoji()
                                @(string.IsNullOrWhiteSpace(entry.Title) ? entry.EntryDate.ToString("MMMM dd, yyyy") : entry.Title)
                            </h5>
                            <small>@entry.EntryDate.ToString("MMM dd, yyyy")</small>
                        </div>
                        <p class="mb-1 text-truncate">@GetPlainTextPreview(entry.Content, 100)</p>
                        <small>
                            <span class="badge"
                                  style="background-color: @entry.PrimaryMoodCategory.GetCategoryColor();">@entry.PrimaryMood</span>
                            @foreach (var tag in entry.Tags.Take(3))
                            {
                                <span class="badge bg-info ms-1">@tag.Name</span>
                            }
                            @if (entry.Tags.Count > 3)
                            {
                                <span class="badge bg-light text-dark ms-1">+@(entry.Tags.Count - 3) more</span>
                            }
                            <span class="ms-2 text-muted">@entry.WordCount words</span>
                        </small>
                    </a>
                }
            </div>

            <!-- Pagination -->
            @if (_searchResult.TotalPages > 1)
            {
                var currentPage = _searchModel.Page;
                var totalPages = _searchResult.TotalPages;

                var windowSize = 5;
                var startPage = Math.Max(1, currentPage - windowSize / 2);
                var endPage = Math.Min(totalPages, startPage + windowSize - 1);

                // Adjust start if we're near the end
                if (endPage - startPage + 1 < windowSize)
                {
                    startPage = Math.Max(1, endPage - windowSize + 1);
                }

                <nav class="mt-4">
                    <ul class="pagination justify-content-center">

                        <!-- Previous -->
                        <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                            <button class="page-link"
                                    @onclick="() => GoToPage(currentPage - 1)">
                                Previous
                            </button>
                        </li>

                        <!-- Page Numbers -->
                        @for (int i = startPage; i <= endPage; i++)
                        {
                            var pageNum = i;
                            <li class="page-item @(currentPage == pageNum ? "active" : "")">
                                <button class="page-link"
                                        @onclick="() => GoToPage(pageNum)">
                                    @pageNum
                                </button>
                            </li>
                        }

                        <!-- Next -->
                        <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                            <button class="page-link"
                                    @onclick="() => GoToPage(currentPage + 1)">
                                Next
                            </button>
                        </li>

                    </ul>
                </nav>
            }

        }
        else
        {
            <div class="alert alert-info">
                <p>No journal entries found.</p>
                <a href="/journal" class="btn btn-primary">Create Your First Entry</a>
            </div>
        }
    </div>
}

@code {
    private JournalSearchModel _searchModel = new() { PageSize = 5 };
    private JournalSearchResultModel _searchResult = new();
    private DateTime? _fromDate;
    private DateTime? _toDate;
    private string _selectedMood = "";

    private bool _isLoading = true;
    private bool _isLoggedIn;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        var userResult = await UserService.GetCurrentUserAsync();
        _isLoggedIn = userResult.Success && userResult.Data != null;

        if (!_isLoggedIn)
        {
            _isLoading = false;
            return;
        }

        await Search();
        _isLoading = false;
    }

    private async Task Search()
    {
        _errorMessage = null;

        try
        {
            _searchModel.From = _fromDate;
            _searchModel.To = _toDate;

            if (!string.IsNullOrEmpty(_selectedMood) && Enum.TryParse<Mood>(_selectedMood, out var mood))
            {
                _searchModel.Moods = new List<Mood> { mood };
            }
            else
            {
                _searchModel.Moods = null;
            }

            var result = await JournalService.SearchAsync(_searchModel);
            if (result.Success)
            {
                _searchResult = result.Data ?? new();
            }
            else
            {
                _errorMessage = result.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > _searchResult.TotalPages) return;

        _searchModel.Page = page;
        await Search();
    }

    private string GetPlainTextPreview(string content, int maxLength)
    {
        if (string.IsNullOrEmpty(content)) return "";

        // Strip HTML tags
        var plainText = System.Text.RegularExpressions.Regex.Replace(content, "<[^>]*>", " ");
        plainText = System.Net.WebUtility.HtmlDecode(plainText);
        plainText = System.Text.RegularExpressions.Regex.Replace(plainText, @"\s+", " ").Trim();

        return plainText.Length > maxLength ? plainText.Substring(0, maxLength) + "..." : plainText;
    }

    private async Task ExportToPdf()
    {
        Console.WriteLine("Exporting analytics to PDF...");
        try
        {
            // var html = await JS.InvokeAsync<string>("eval", "document.documentElement.outerHTML");
            string html = await JS.InvokeAsync<string>("getPageHtmlWithStyles");

            // Base app sandbox folder
            var appData = FileSystem.Current.AppDataDirectory;

// Create "JournalExports" subfolder
            var exportFolder = Path.Combine(appData, "JournalExports");
            Directory.CreateDirectory(exportFolder); // ensures folder exists

// Create a timestamped PDF file path
            var filePath = Path.Combine(exportFolder, $"Export-{DateTime.Now:yyyyMMddHHmmss}.pdf");

            await PdfService.GeneratePdfAsync(html, filePath);

// Best approach: prepend "file://"
            var fileUri = new Uri($"file://{filePath}");

            await Launcher.Default.OpenAsync(fileUri);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
    }

    private async Task ExportJournalsToPdf()
    {
        try
        {
            var searchModel = new JournalSearchModel
            {
                Query = _searchModel.Query,
                From = _searchModel.From,
                To = _searchModel.To,
                Moods = _searchModel.Moods,
                TagIds = _searchModel.TagIds,
                CategoryId = _searchModel.CategoryId,
                Page = 1,
                PageSize = 1000 // Export up to 1000 entries
            };
            var result = await JournalService.SearchAsync(searchModel);
            if (!result.Success || result.Data == null || result.Data.Entries.Count == 0)
            {
                await JS.InvokeVoidAsync("alert", "No journals found for the selected filter.");
                return;
            }

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("<html><head><title>Exported Journals</title>");
            sb.AppendLine("<link rel='stylesheet' href='/css/bootstrap.min.css'>");
            sb.AppendLine("<style>@media print { .page-break { page-break-before: always; } }</style>");
            sb.AppendLine("</head><body>");

            foreach (var entry in result.Data.Entries)
            {
                // Secondary moods
                string secondaryMoodsHtml = "";
                if (entry.SecondaryMoods != null && entry.SecondaryMoods.Count > 0)
                {
                    foreach (var m in entry.SecondaryMoods)
                    {
                        secondaryMoodsHtml += $"<span class='badge bg-secondary ms-1'>{m.GetEmoji()} {m}</span> ";
                    }
                }

                // Tags
                string tagsHtml = "";
                if (entry.Tags != null && entry.Tags.Count > 0)
                {
                    foreach (var tag in entry.Tags)
                    {
                        tagsHtml += $"<span class='badge bg-info text-dark'>{tag.Name}</span> ";
                    }
                }

                // Updated at
                string updatedAtHtml = entry.UpdatedAt != entry.CreatedAt
                    ? $"<div class='mb-2'><strong>Last Updated:</strong> {entry.UpdatedAt}</div>"
                    : "";

                sb.AppendLine($@"
<div class='container mt-4'>
    <div class='card mb-4'>
        <div class='card-header'>
            <h4>{entry.Title}</h4>
            <small class='text-muted'>{entry.EntryDate:dddd, MMMM d, yyyy}</small>
        </div>
        <div class='card-body'>
            <div class='mb-2'>
                <span class='badge' style='background-color: {entry.PrimaryMoodCategory.GetCategoryColor()};'>{entry.PrimaryMood.GetEmoji()} {entry.PrimaryMood}</span>
                {secondaryMoodsHtml}
            </div>
            <div class='mb-2'>
                {tagsHtml}
            </div>
            <div class='mb-2'><strong>Word Count:</strong> {entry.WordCount}</div>
            <div class='mb-2'><strong>Created:</strong> {entry.CreatedAt}</div>
            {updatedAtHtml}
            <div class='mt-3' id='journal-content'>{entry.Content}</div>
        </div>
    </div>
</div>
<div class='page-break'></div>");
            }

            sb.AppendLine("</body></html>");
            var html = sb.ToString();


            // Base app sandbox folder
            var appData = FileSystem.Current.AppDataDirectory;

// Create "JournalExports" subfolder
            var exportFolder = Path.Combine(appData, "JournalExports");
            Directory.CreateDirectory(exportFolder); // ensures folder exists

// Create a timestamped PDF file path
            var filePath = Path.Combine(exportFolder, $"Export-{DateTime.Now:yyyyMMddHHmmss}.pdf");

            await PdfService.GeneratePdfAsync(html, filePath);

// Best approach: prepend "file://"
            var fileUri = new Uri($"file://{filePath}");

            await Launcher.Default.OpenAsync(fileUri);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Export failed: {ex.Message}");
        }
    }

}

