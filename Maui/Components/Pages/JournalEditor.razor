@page "/editor"
@using Application.Interfaces
@using Domain.Entities


<h3>Daily Journal</h3>

<div class="form-group">
    <label>Date:</label>
    <input type="date"
           @bind="_entryDate"
           @bind:event="onchange"
           @bind:after="OnDateChanged" />
</div>

<div class="form-group">
    <label>Title:</label>
    <input type="text" style="width:100%;" @bind="_title" maxlength="200" />
</div>

<div class="form-group">
    <label>Primary Mood:</label>
    <select @bind="_primaryMood">
        @foreach (var m in Enum.GetValues(typeof(Mood)).Cast<Mood>())
        {
            <option value="@m">@m</option>
        }
    </select>
</div>

<div class="form-group">
    <label>Secondary Moods:</label>
    <select multiple style="width:100%; min-height: 3em;" @onchange="OnSecondaryMoodsChanged">
        @foreach (var m in Enum.GetValues(typeof(Mood)).Cast<Mood>())
        {
            <option value="@m" selected="@_secondaryMoods.Contains(m)">@m</option>
        }
    </select>
</div>

<div class="form-group">
    <label>Category:</label>
    <!-- Placeholder: categories should be loaded from service -->
    <select @bind="_categoryId">
        <option value="">(None)</option>
        @* TODO: Populate with categories from service *@
    </select>
</div>

<div class="form-group">
    <label>Tags:</label>
    <div>
        <input type="text" @bind="_newTag" placeholder="Add tag..." @onkeydown="OnTagInputKeyDown" />
        <button @onclick="AddTag">Add</button>
    </div>
    <div>
        @foreach (var tag in _tags)
        {
            <span class="tag-chip">@tag <button @onclick="() => RemoveTag(tag)">x</button></span>
        }
    </div>
</div>

<div class="form-group">
    <label>Content:</label>
    <textarea rows="16" style="width:100%;" @bind="_content"></textarea>
</div>

<button @onclick="Save">Save</button>
<span style="margin-left:1em; color:green;">@_statusMessage</span>

@code {
    [Inject]
    public IJournalService JournalService { get; set; } = null!;


    private DateTime _entryDate = DateTime.Today;
    private string _title = string.Empty;
    private string _content = string.Empty;
    private Mood _primaryMood = Mood.Thoughtful;
    private List<Mood> _secondaryMoods = new();
    private Guid? _categoryId = null;
    private List<string> _tags = new();
    private string _newTag = string.Empty;
    private JournalEntry? _current;
    private string _statusMessage = string.Empty;

    private void OnSecondaryMoodsChanged(ChangeEventArgs e)
    {
        var selected = e.Value as IEnumerable<string>;
        if (selected == null && e.Value is string single)
        {
            selected = new[] { single };
        }
        _secondaryMoods = selected?.Select(s => Enum.TryParse<Mood>(s, out var mood) ? mood : (Mood?)null)
            .Where(m => m.HasValue && m.Value != _primaryMood)
            .Select(m => m!.Value).ToList() ?? new List<Mood>();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadForDate(_entryDate);
        // TODO: Load categories from service if available
        // TODO: Load all tags from service if you want tag suggestions
    }

    private async Task OnDateChanged()
    {
        await LoadForDate(_entryDate);
    }


    private async Task LoadForDate(DateTime date)
    {
        _current = await JournalService.GetEntryByDateAsync(date);
        if (_current != null)
        {
            _title = _current.Title;
            _content = _current.Content;
            _primaryMood = _current.PrimaryMood;
            _secondaryMoods = ParseSecondaryMoods(_current.SecondaryMoods);
            _categoryId = _current.CategoryId;
            _tags = _current.EntryTags.Select(et => et.Tag.Name).ToList();
        }
        else
        {
            _title = string.Empty;
            _content = string.Empty;
            _primaryMood = Mood.Thoughtful;
            _secondaryMoods = new();
            _categoryId = null;
            _tags = new();
        }
    }


    private async Task Save()
    {
        var entry = new JournalEntry
        {
            EntryDate = _entryDate.Date,
            Title = _title,
            Content = _content,
            IsMarkdown = true,
            PrimaryMood = _primaryMood,
            SecondaryMoods = string.Join(",", _secondaryMoods),
            CategoryId = _categoryId,
            EntryTags = _tags.Select(t => new EntryTag { Tag = new Tag { Name = t } }).ToList()
        };

        await JournalService.AddOrUpdateEntryAsync(entry);
        _statusMessage = "Saved";
    }

    private List<Mood> ParseSecondaryMoods(string? moods)
    {
        if (string.IsNullOrWhiteSpace(moods)) return new();
        return moods.Split(',').Select(m => Enum.TryParse<Mood>(m, out var mood) ? mood : (Mood?)null).Where(m => m.HasValue && m.Value != _primaryMood).Select(m => m!.Value).ToList();
    }

    private void AddTag()
    {
        var tag = _newTag.Trim();
        if (!string.IsNullOrEmpty(tag) && !_tags.Contains(tag, StringComparer.OrdinalIgnoreCase))
        {
            _tags.Add(tag);
        }
        _newTag = string.Empty;
    }

    private void RemoveTag(string tag)
    {
        _tags.Remove(tag);
    }

    private void OnTagInputKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddTag();
        }
    }
}