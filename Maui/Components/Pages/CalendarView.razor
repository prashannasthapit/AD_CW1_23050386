@page "/calendar"
@using Application.Interfaces
@using Domain.Entities
@inject IJournalService JournalService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Class="mr-2" />
        Calendar View
    </MudText>

    <MudGrid>
        <!-- Calendar -->
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft"
                                   OnClick="PreviousMonth"
                                   Color="Color.Primary" />
                    <MudText Typo="Typo.h5">
                        @_currentMonth.ToString("MMMM yyyy")
                    </MudText>
                    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight"
                                   OnClick="NextMonth"
                                   Color="Color.Primary"
                                   Disabled="@(_currentMonth.Year == DateTime.Today.Year && _currentMonth.Month == DateTime.Today.Month)" />
                </MudStack>

                @if (_isLoading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                }

                <!-- Calendar Grid -->
                <div class="calendar-grid">
                    <!-- Day Headers -->
                    @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                    {
                        <div class="calendar-header">
                            <MudText Typo="Typo.caption" Align="Align.Center">@day</MudText>
                        </div>
                    }

                    <!-- Calendar Days -->
                    @foreach (var date in GetCalendarDates())
                    {
                        var entry = GetEntryForDate(date);
                        var isCurrentMonth = date.Month == _currentMonth.Month;
                        var isToday = date.Date == DateTime.Today;
                        var hasEntry = entry != null;

                        <div class="calendar-day @(isCurrentMonth ? "" : "other-month") @(isToday ? "today" : "") @(hasEntry ? "has-entry" : "")"
                             @onclick="@(() => OnDateClick(date))">
                            <div class="day-number">
                                <MudText Typo="Typo.body2" 
                                         Color="@(isCurrentMonth ? Color.Default : Color.Secondary)">
                                    @date.Day
                                </MudText>
                            </div>
                            @if (hasEntry)
                            {
                                <div class="entry-indicator" 
                                     style="background-color: @entry!.PrimaryMood.GetCategory().GetCategoryColor()">
                                    <MudText Typo="Typo.caption">@entry.PrimaryMood.GetEmoji()</MudText>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Legend -->
                <MudStack Row="true" Justify="Justify.Center" Class="mt-4" Spacing="4">
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #4caf50;"></div>
                        <MudText Typo="Typo.caption">Positive</MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #2196f3;"></div>
                        <MudText Typo="Typo.caption">Neutral</MudText>
                    </MudStack>
                    <MudStack Row="true" AlignItems="AlignItems.Center">
                        <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #f44336;"></div>
                        <MudText Typo="Typo.caption">Negative</MudText>
                    </MudStack>
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Entry Preview / Stats -->
        <MudItem xs="12" md="4">
            @if (_selectedDate.HasValue)
            {
                var selectedEntry = GetEntryForDate(_selectedDate.Value);
                <MudPaper Class="pa-4 mb-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-2">
                        @_selectedDate.Value.ToString("MMMM d, yyyy")
                    </MudText>
                    
                    @if (selectedEntry != null)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudAvatar Size="Size.Medium" 
                                       Style="@($"background-color: {selectedEntry.PrimaryMood.GetCategory().GetCategoryColor()}")">
                                @selectedEntry.PrimaryMood.GetEmoji()
                            </MudAvatar>
                            <div>
                                <MudText Typo="Typo.body1">@selectedEntry.PrimaryMood</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Primary Mood</MudText>
                            </div>
                        </MudStack>

                        @if (!string.IsNullOrEmpty(selectedEntry.Title))
                        {
                            <MudText Typo="Typo.subtitle1" Class="mb-2">@selectedEntry.Title</MudText>
                        }

                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3" 
                                 Style="max-height: 150px; overflow: hidden;">
                            @GetContentPreview(selectedEntry.Content)
                        </MudText>

                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-3">
                            @selectedEntry.WordCount words
                            @if (selectedEntry.Category != null)
                            {
                                <text> â€¢ @selectedEntry.Category.Name</text>
                            }
                        </MudText>

                        @if (selectedEntry.EntryTags.Any())
                        {
                            <MudStack Row="true" Class="mb-3" Style="flex-wrap: wrap; gap: 4px;">
                                @foreach (var tag in selectedEntry.EntryTags.Take(5))
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">
                                        @tag.Tag.Name
                                    </MudChip>
                                }
                            </MudStack>
                        }

                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Edit"
                                   OnClick="@(() => Navigation.NavigateTo($"/entry/{_selectedDate.Value:yyyy-MM-dd}"))">
                            Edit Entry
                        </MudButton>
                    }
                    else if (_selectedDate.Value.Date <= DateTime.Today)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                            No entry for this date.
                        </MudText>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   OnClick="@(() => Navigation.NavigateTo($"/entry/{_selectedDate.Value:yyyy-MM-dd}"))">
                            Create Entry
                        </MudButton>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Future dates cannot have entries.
                        </MudText>
                    }
                </MudPaper>
            }

            <!-- Monthly Stats -->
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h6" Class="mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.Analytics" Size="Size.Small" Class="mr-1" />
                    Monthly Stats
                </MudText>
                
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.body2">Entries this month:</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Primary">
                            <b>@_monthEntries.Count</b>
                        </MudText>
                    </MudStack>
                    
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        <MudText Typo="Typo.body2">Completion rate:</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Primary">
                            <b>@GetCompletionRate()%</b>
                        </MudText>
                    </MudStack>
                    
                    @if (_monthMoodCounts.Any())
                    {
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Mood breakdown:</MudText>
                        @foreach (var moodCount in _monthMoodCounts.OrderByDescending(m => m.Value).Take(5))
                        {
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2">
                                    @moodCount.Key.GetEmoji() @moodCount.Key
                                </MudText>
                                <MudChip T="int" 
                                         Size="Size.Small" 
                                         Color="@GetMoodCategoryColor(moodCount.Key.GetCategory())">
                                    @moodCount.Value
                                </MudChip>
                            </MudStack>
                        }
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }
    
    .calendar-header {
        padding: 8px;
        text-align: center;
        font-weight: 600;
    }
    
    .calendar-day {
        min-height: 80px;
        padding: 8px;
        border: 1px solid var(--mud-palette-divider);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
    }
    
    .calendar-day:hover {
        background-color: var(--mud-palette-action-default-hover);
        transform: scale(1.02);
    }
    
    .calendar-day.other-month {
        opacity: 0.4;
    }
    
    .calendar-day.today {
        border-color: var(--mud-palette-primary);
        border-width: 2px;
    }
    
    .calendar-day.has-entry {
        background-color: var(--mud-palette-background-gray);
    }
    
    .day-number {
        text-align: right;
    }
    
    .entry-indicator {
        margin-top: auto;
        padding: 4px 8px;
        border-radius: 4px;
        text-align: center;
        font-size: 1.2em;
    }
</style>

@code {
    private bool _isLoading = true;
    private DateTime _currentMonth = new(DateTime.Today.Year, DateTime.Today.Month, 1);
    private DateTime? _selectedDate = DateTime.Today;
    private IList<JournalEntry> _monthEntries = new List<JournalEntry>();
    private Dictionary<Mood, int> _monthMoodCounts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthEntries();
        _isLoading = false;
    }

    private async Task LoadMonthEntries()
    {
        _isLoading = true;
        StateHasChanged();

        var startOfMonth = new DateTime(_currentMonth.Year, _currentMonth.Month, 1);
        var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);

        var result = await JournalService.SearchAsync(
            null, startOfMonth, endOfMonth, null, null, null, 1, 50);

        _monthEntries = result.Entries;
        _monthMoodCounts = _monthEntries
            .GroupBy(e => e.PrimaryMood)
            .ToDictionary(g => g.Key, g => g.Count());

        _isLoading = false;
        StateHasChanged();
    }

    private IEnumerable<DateTime> GetCalendarDates()
    {
        var firstOfMonth = new DateTime(_currentMonth.Year, _currentMonth.Month, 1);
        var daysInMonth = DateTime.DaysInMonth(_currentMonth.Year, _currentMonth.Month);
        
        // Start from the Sunday before the first of the month
        var startDate = firstOfMonth.AddDays(-(int)firstOfMonth.DayOfWeek);
        
        // Generate 6 weeks (42 days) to ensure we cover all dates
        for (int i = 0; i < 42; i++)
        {
            yield return startDate.AddDays(i);
        }
    }

    private JournalEntry? GetEntryForDate(DateTime date)
    {
        return _monthEntries.FirstOrDefault(e => e.EntryDate.Date == date.Date);
    }

    private void OnDateClick(DateTime date)
    {
        _selectedDate = date;
    }

    private async Task PreviousMonth()
    {
        _currentMonth = _currentMonth.AddMonths(-1);
        await LoadMonthEntries();
    }

    private async Task NextMonth()
    {
        _currentMonth = _currentMonth.AddMonths(1);
        await LoadMonthEntries();
    }

    private int GetCompletionRate()
    {
        var daysInMonth = DateTime.DaysInMonth(_currentMonth.Year, _currentMonth.Month);
        var today = DateTime.Today;
        
        // Only count days up to today if current month
        int daysToCount;
        if (_currentMonth.Year == today.Year && _currentMonth.Month == today.Month)
        {
            daysToCount = today.Day;
        }
        else if (_currentMonth > today)
        {
            return 0;
        }
        else
        {
            daysToCount = daysInMonth;
        }

        if (daysToCount == 0) return 0;
        return (int)(_monthEntries.Count * 100.0 / daysToCount);
    }

    private string GetContentPreview(string content)
    {
        if (string.IsNullOrEmpty(content))
            return "No content";
        
        var clean = System.Text.RegularExpressions.Regex.Replace(content, @"[#*_`\[\]()]", "");
        return clean.Length > 200 ? clean[..200] + "..." : clean;
    }

    private Color GetMoodCategoryColor(MoodCategory category)
    {
        return category switch
        {
            MoodCategory.Positive => Color.Success,
            MoodCategory.Neutral => Color.Info,
            MoodCategory.Negative => Color.Error,
            _ => Color.Default
        };
    }
}
